(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{408:function(v,_,e){"use strict";e.r(_);var t=e(44),a=Object(t.a)({},(function(){var v=this,_=v.$createElement,e=v._self._c||_;return e("ContentSlotsDistributor",{attrs:{"slot-key":v.$parent.slotKey}},[e("h1",{attrs:{id:"规则说明"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#规则说明"}},[v._v("#")]),v._v(" 规则说明")]),v._v(" "),e("p",[v._v("本模块使用下列几种配置文件，所有的配置文件必须在同一目录下并保证 nginx 对其有读取权限。")]),v._v(" "),e("ul",[e("li",[v._v("IP 白名单，文件名为 "),e("code",[v._v("white-ipv4")]),v._v(" 和 "),e("code",[v._v("white-ipv6")]),v._v("。")]),v._v(" "),e("li",[v._v("IP 黑名单，文件名为 "),e("code",[v._v("ipv4")]),v._v(" 和 "),e("code",[v._v("ipv6")]),v._v("。")]),v._v(" "),e("li",[v._v("Url 白名单，文件名为 "),e("code",[v._v("white-url")]),v._v("。")]),v._v(" "),e("li",[v._v("Url 黑名单，文件名为 "),e("code",[v._v("url")]),v._v("。")]),v._v(" "),e("li",[v._v("Get 参数黑名单，文件名为 "),e("code",[v._v("args")]),v._v("。")]),v._v(" "),e("li",[v._v("Post 请求体黑名单，文件名为 "),e("code",[v._v("post")]),v._v("。")]),v._v(" "),e("li",[v._v("UserAgent 黑名单，文件名为 "),e("code",[v._v("user-agent")]),v._v("。")]),v._v(" "),e("li",[v._v("Cookie 黑名单，文件名为 "),e("code",[v._v("cookie")]),v._v("。")]),v._v(" "),e("li",[v._v("Referer 白名单，文件名为 "),e("code",[v._v("white-referer")]),v._v("。")]),v._v(" "),e("li",[v._v("Referer 黑名单，文件名为 "),e("code",[v._v("referer")]),v._v("。")]),v._v(" "),e("li",[v._v("高级规则，文件名为 "),e("code",[v._v("advaced")]),v._v("。")])]),v._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[v._v("注意")]),v._v(" "),e("p",[v._v("有些规则文件需要书写正则表达式，书写时每行一个正则表达式，\n正则表达式遵循 "),e("a",{attrs:{href:"http://www.pcre.org/current/doc/html/pcre2syntax.html",target:"_blank",rel:"noopener noreferrer"}},[v._v("PCRE 标准"),e("OutboundLink")],1),v._v("。")])]),v._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[v._v("注意")]),v._v(" "),e("p",[v._v("高级规则仅在开发版中可用。")])]),v._v(" "),e("h2",{attrs:{id:"基础规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基础规则"}},[v._v("#")]),v._v(" 基础规则")]),v._v(" "),e("h3",{attrs:{id:"ip白名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip白名单"}},[v._v("#")]),v._v(" ip白名单")]),v._v(" "),e("p",[v._v("ip 白名单包括下面两个文件。")]),v._v(" "),e("ul",[e("li",[v._v("ipv4 白名单，文件名为 "),e("code",[v._v("white-ipv4")]),v._v("。")]),v._v(" "),e("li",[v._v("ipv6 白名单，文件名为 "),e("code",[v._v("white-ipv6")]),v._v("。")])]),v._v(" "),e("p",[v._v("书写时一行指定一个 IP 地址或者 IP 地址块。ipv4 地址必须使用「点分十进制表示法」，\nipv6 地址必须使用 「冒号十六进制表示法」。下面举一些例子。")]),v._v(" "),e("p",[v._v("指定单个 ipv4 地址。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("192.168.2.1\n")])])]),e("p",[v._v("指定一个 ipv4 地址块。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("192.168.2.0/24\n")])])]),e("p",[v._v("指定单个 ipv6 地址。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("FE80::1000\n")])])]),e("p",[v._v("指定一个 ipv6 地址块。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("FE80::/10\n")])])]),e("h3",{attrs:{id:"ip黑名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip黑名单"}},[v._v("#")]),v._v(" IP黑名单")]),v._v(" "),e("p",[v._v("IP 黑名单包括下面两个文件。")]),v._v(" "),e("ul",[e("li",[v._v("ipv4 黑名单，文件名为 "),e("code",[v._v("ipv4")]),v._v("。")]),v._v(" "),e("li",[v._v("ipv6 黑名单，文件名为 "),e("code",[v._v("ipv6")]),v._v("。")])]),v._v(" "),e("p",[v._v("写法同 "),e("a",{attrs:{href:"#ip%E7%99%BD%E5%90%8D%E5%8D%95"}},[v._v("ip 白名单")]),v._v("。")]),v._v(" "),e("h3",{attrs:{id:"url白名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#url白名单"}},[v._v("#")]),v._v(" url白名单")]),v._v(" "),e("p",[v._v("Url 白名单的文件名为 "),e("code",[v._v("white-url")]),v._v("，书写规则时每行指定一个正则表达式，\nUrl 被任何一个正则表达式匹配到就会直接放行，不进行后续的检查。")]),v._v(" "),e("h3",{attrs:{id:"url黑名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#url黑名单"}},[v._v("#")]),v._v(" url黑名单")]),v._v(" "),e("p",[v._v("Url 黑名单的文件名为 "),e("code",[v._v("url")]),v._v("，书写规则时每行指定一个正则表达式，\nUrl 被任何一个正则表达式匹配到就会被拦截，返回 403 状态码。")]),v._v(" "),e("h3",{attrs:{id:"get参数黑名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#get参数黑名单"}},[v._v("#")]),v._v(" get参数黑名单")]),v._v(" "),e("p",[v._v("Get 参数黑名单的文件名为 "),e("code",[v._v("args")]),v._v("，书写规则时每行指定一个正则表达式，\nGet 参数被任何一个正则表达式匹配到就会被拦截，返回 403 状态码。")]),v._v(" "),e("h3",{attrs:{id:"post请求体黑名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#post请求体黑名单"}},[v._v("#")]),v._v(" post请求体黑名单")]),v._v(" "),e("p",[v._v("Post 请求体黑名单的文件名为 "),e("code",[v._v("post")]),v._v("，书写规则时每行指定一个正则表达式，\nPost 请求体内的内容被任何一个正则表达式匹配到就会被拦截，返回 403 状态码。")]),v._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[v._v("警告")]),v._v(" "),e("p",[v._v("有时本模块不会执行 Post 请求体检查，详见"),e("RouterLink",{attrs:{to:"/zh-cn/guide/faq.html#post检测失效"}},[v._v("常见问题与解答")]),v._v("。")],1)]),v._v(" "),e("h3",{attrs:{id:"user-agent黑名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#user-agent黑名单"}},[v._v("#")]),v._v(" user-agent黑名单")]),v._v(" "),e("p",[v._v("UserAgent 黑名单的文件名为 "),e("code",[v._v("user-agent")]),v._v("，书写规则时每行指定一个正则表达式，\nUserAgent 被任何一个正则表达式匹配到就会被拦截，返回 403 状态码。")]),v._v(" "),e("h3",{attrs:{id:"cookie黑名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#cookie黑名单"}},[v._v("#")]),v._v(" cookie黑名单")]),v._v(" "),e("p",[v._v("Cookie 黑名单的文件名为 "),e("code",[v._v("cookie")]),v._v("，书写规则时每行指定一个正则表达式，\nCookie 被任何一个正则表达式匹配到就会被拦截，返回 403 状态码。")]),v._v(" "),e("h3",{attrs:{id:"referer白名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#referer白名单"}},[v._v("#")]),v._v(" referer白名单")]),v._v(" "),e("p",[v._v("Referer 白名单的文件名为 "),e("code",[v._v("white-referer")]),v._v("，书写规则时每行指定一个正则表达式，\nReferer 被任何一个正则表达式匹配到就会直接放行，不进行后续的检查。")]),v._v(" "),e("h3",{attrs:{id:"referer黑名单"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#referer黑名单"}},[v._v("#")]),v._v(" referer黑名单")]),v._v(" "),e("p",[v._v("Referer 黑名单的文件名为 "),e("code",[v._v("referer")]),v._v("，书写规则时每行指定一个正则表达式，\nReferer 被任何一个正则表达式匹配到就会被拦截，返回 403 状态码。")]),v._v(" "),e("h2",{attrs:{id:"高级规则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#高级规则"}},[v._v("#")]),v._v(" 高级规则")]),v._v(" "),e("h3",{attrs:{id:"概述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[v._v("#")]),v._v(" 概述")]),v._v(" "),e("p",[v._v("高级规则是一种将条件表达式和动作组合起来的规则，只有满足指定的条件时才会执行对应的动作。高级规则更加灵活，但是也更加消耗性能。")]),v._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[v._v("注意")]),v._v(" "),e("p",[v._v("高级规则的性能较慢，因为其原理是将规则编译成一系列指令，然后由虚拟机执行。")])]),v._v(" "),e("h3",{attrs:{id:"示例"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#示例"}},[v._v("#")]),v._v(" 示例")]),v._v(" "),e("p",[v._v("下面的例子表示如果 "),e("code",[v._v("url")]),v._v(" 中包含 "),e("code",[v._v("/install")]),v._v(" 则返回 HTTP 403 状态码。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("id: example\nif: url contains '/install'\ndo: return(403)\n")])])]),e("hr"),v._v(" "),e("p",[v._v("下面的例子表示如果 "),e("code",[v._v("user-agent")]),v._v(" 中不包含 "),e("code",[v._v("secret")]),v._v(" 则返回 HTTP 403 状态码。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("id: example\nif: user-agent not equals 'secret'\ndo: return(403)\n")])])]),e("hr"),v._v(" "),e("p",[v._v("下面的例子表示如果 "),e("code",[v._v("url")]),v._v(" 能够正则表达式 "),e("code",[v._v("^/admin")]),v._v(" 所匹配，或者 "),e("code",[v._v("user-agent")]),v._v(" 等于 "),e("code",[v._v("secret")]),v._v(" 则停止后续的所有检测并放行本次请求。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("id: example\nif: url matches '^/admin' or user-agent equals 'secret'\ndo: allow\n")])])]),e("hr"),v._v(" "),e("p",[v._v("下面的例子表示如果查询字符串中的参数 "),e("code",[v._v("user_id")]),v._v(" 的内容被检测出 SQL 注入则返回 HTTP 403 状态码。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("id: example\nif: sqli_detn(query_string[user_id])\ndo: return(403)\n")])])]),e("hr"),v._v(" "),e("p",[v._v("下面的例子表示如果客户端发送的请求头中 "),e("code",[v._v("X-Passwod")]),v._v(" 的值不等于 "),e("code",[v._v("password")]),v._v(" 则返回 HTTP 403 状态码。")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("id: example\nif: header_in[X-Passwod] not equals 'password'\ndo: return(403)\n")])])]),e("h3",{attrs:{id:"语法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#语法"}},[v._v("#")]),v._v(" 语法")]),v._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[v._v("id: example\nif: condition\ndo: action\n\nid: example\nif: condition\ndo: action\n")])])]),e("p",[v._v("多条规则之间必须间隔一行，并且只能间隔一行。\n最后一条规则的末尾不能有任何字符。")]),v._v(" "),e("ul",[e("li",[v._v("id：每条规则都有一个唯一的 ID，这个 ID 会在规则生效时记录在日志中。每条规则只能有一个 ID，不同规则可以有相同的 ID。")]),v._v(" "),e("li",[v._v("if：如果 "),e("code",[v._v("condition")]),v._v(" 为真则执行 "),e("code",[v._v("action")]),v._v("。")]),v._v(" "),e("li",[v._v("do：当 "),e("code",[v._v("condition")]),v._v(" 为真则时执行 "),e("code",[v._v("action")]),v._v("。")])]),v._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[v._v("注意")]),v._v(" "),e("p",[v._v("所有的关键字均大小写不敏感。")])]),v._v(" "),e("h3",{attrs:{id:"condition"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#condition"}},[v._v("#")]),v._v(" Condition")]),v._v(" "),e("p",[e("code",[v._v("condition")]),v._v("是一系列条件表达式的组合，条件表达式由运算符符和运算数组成。")]),v._v(" "),e("ul",[e("li",[v._v("字符串运算符\n"),e("ul",[e("li",[v._v("equals\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("left equals right")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：如果左右两个字符串相等则为真，反之为假。")])])]),v._v(" "),e("li",[v._v("contains\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("left contains right")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：如果 "),e("code",[v._v("right")]),v._v(" 是 "),e("code",[v._v("left")]),v._v(" 的一个子串则为真，反之为假。")])])]),v._v(" "),e("li",[v._v("matches\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("str matches regexp")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：如果 "),e("code",[v._v("str")]),v._v(" 能被正则表达式 "),e("code",[v._v("regexp")]),v._v(" 所匹配则为真，反之为假。")]),v._v(" "),e("li",[v._v("注意：如果 "),e("code",[v._v("regexp")]),v._v(" 不是合法的正则表达式则为假。")])])]),v._v(" "),e("li",[v._v("sqli_detn\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("sqli_detn(str)")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：如果 "),e("code",[v._v("str")]),v._v(" 中是否存在 SQL 注入则为真，反之为假。")])])]),v._v(" "),e("li",[v._v("xss_detn\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("xss_detn(str)")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：如果 "),e("code",[v._v("str")]),v._v(" 中存在 XSS 攻击则为真，反之为假。")])])])])])]),v._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[v._v("注意")]),v._v(" "),e("ul",[e("li",[e("code",[v._v("detn")]),v._v(" 是 "),e("code",[v._v("detection")]),v._v(" 的缩写。")]),v._v(" "),e("li",[e("code",[v._v("sqli")]),v._v(" 是 "),e("code",[v._v("SQL injection")]),v._v(" 的缩写。")])])]),v._v(" "),e("ul",[e("li",[e("p",[v._v("IP 运算符：")]),v._v(" "),e("ul",[e("li",[v._v("equals\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("client_ip equals str")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：如果 "),e("code",[v._v("str")]),v._v(" 所表示的 IP 与 "),e("code",[v._v("client_ip")]),v._v(" 相同则为真，反之为假。")]),v._v(" "),e("li",[v._v("注意\n"),e("ul",[e("li",[e("code",[v._v("str")]),v._v(" 是一个点分十进制或冒号十六进制表示的 IP 字符串，如果格式错误则为假。")]),v._v(" "),e("li",[v._v("当左右两个运算数的 IP 类型不一致时为假。")]),v._v(" "),e("li",[e("code",[v._v("client_ip")]),v._v(" 是关键字，表示客户端的 IP 地址。")])])])])]),v._v(" "),e("li",[v._v("belong_to\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("client_ip belong_to str")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：如果 "),e("code",[v._v("str")]),v._v(" 所表示的 IP 地址块包含 "),e("code",[v._v("client_ip")]),v._v(" 则为真，反之为假。")]),v._v(" "),e("li",[v._v("注意\n"),e("ul",[e("li",[e("code",[v._v("str")]),v._v(" 是一个点分十进制或冒号十六进制表示的 IP 字符串，如果格式错误则为假。")]),v._v(" "),e("li",[v._v("当左右两个运算数的 IP 类型不一致时为假。")]),v._v(" "),e("li",[e("code",[v._v("client_ip")]),v._v(" 是关键字，表示客户端的 IP 地址。")])])])])])])]),v._v(" "),e("li",[e("p",[v._v("逻辑运算符")]),v._v(" "),e("ul",[e("li",[v._v("and\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("condition and condition")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：逻辑与。")])])]),v._v(" "),e("li",[v._v("or\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("condition or condition")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：逻辑或。")])])]),v._v(" "),e("li",[v._v("not\n"),e("ul",[e("li",[v._v("格式\n"),e("ul",[e("li",[e("code",[v._v("not operator")]),v._v("。")]),v._v(" "),e("li",[e("code",[v._v("not (condition)")]),v._v("。")])])]),v._v(" "),e("li",[v._v("功能：逻辑非。")]),v._v(" "),e("li",[v._v("示例\n"),e("ul",[e("li",[e("code",[v._v("not equals")]),v._v("。")]),v._v(" "),e("li",[e("code",[v._v("not belong_to")]),v._v("。")])])])])])])]),v._v(" "),e("li",[e("p",[v._v("其它运算符")]),v._v(" "),e("ul",[e("li",[v._v("()\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("(condition)")])]),v._v(" "),e("li",[v._v("功能：括号运算符，用来改变优先级，功能类似数学中的括号。")])])])])])]),v._v(" "),e("h3",{attrs:{id:"action"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#action"}},[v._v("#")]),v._v(" Action")]),v._v(" "),e("p",[e("code",[v._v("Action")]),v._v(" 是在 "),e("code",[v._v("if")]),v._v(" 条件满足后执行的动作。")]),v._v(" "),e("ul",[e("li",[v._v("return\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("return(http_status)")]),v._v("。")]),v._v(" "),e("li",[v._v("功能：立即停止所有的检测并返回指定的 HTTP 状态码。")]),v._v(" "),e("li",[v._v("示例："),e("code",[v._v("return(403)")]),v._v("。")])])]),v._v(" "),e("li",[v._v("allow\n"),e("ul",[e("li",[v._v("格式："),e("code",[v._v("allow")])]),v._v(" "),e("li",[v._v("功能：立即停止所有的检测并放行本次请求。")])])])]),v._v(" "),e("h3",{attrs:{id:"其它关键字"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#其它关键字"}},[v._v("#")]),v._v(" 其它关键字")]),v._v(" "),e("h4",{attrs:{id:"字符串类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#字符串类型"}},[v._v("#")]),v._v(" 字符串类型")]),v._v(" "),e("ul",[e("li",[v._v("url：如果用户请求 "),e("code",[v._v("http(s)://localhost/index.html?smth=smth")]),v._v("，则值为"),e("code",[v._v("index.html")]),v._v("。")]),v._v(" "),e("li",[v._v("query_string["),e("em",[v._v("key")]),v._v("]：如果用户请求 "),e("code",[v._v("http(s)://localhost/index.html?key=one&ex=two")]),v._v(" ，则值为 "),e("code",[v._v("one")]),v._v("。")]),v._v(" "),e("li",[v._v("user-agent: 你知道的，就是 "),e("code",[v._v("user-agent")]),v._v("。")]),v._v(" "),e("li",[v._v("referer：你知道的，就是 "),e("code",[v._v("referer")]),v._v("。")]),v._v(" "),e("li",[v._v("cookie["),e("em",[v._v("key")]),v._v("]：如果 Cookie 为 "),e("code",[v._v("key=one&ex=two")]),v._v(" 则值为 "),e("code",[v._v("one")]),v._v("。")]),v._v(" "),e("li",[v._v("header_in["),e("em",[v._v("key")]),v._v("]：表示请求头中对应字段的值。")])]),v._v(" "),e("h4",{attrs:{id:"ip-类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#ip-类型"}},[v._v("#")]),v._v(" IP 类型")]),v._v(" "),e("ul",[e("li",[v._v("client_ip：表示客户端的 IP 地址。")])])])}),[],!1,null,null,null);_.default=a.exports}}]);